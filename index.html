<!DOCTYPE html>
<html lang="en">

<head>

	<!--
		FEATURES TO IMPLEMENT:
		* Radial / femoral
		* What does xxx fit in to ?
		* Info box
		* Delete running properly
		* Cross/delete on iphone
		* Unit convertor
		* Potential incompatibilities: e.g. Flowgate and ACE/Sofia
		* Frictionless submission of incompatibility

	-->

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<title>NeuroTool: Neurointervention Device Sizer</title>
	<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
	<link type="text/css" rel="stylesheet" href="css/bootstrap-vue.css" />
	<link href="css/VueBootstrapTypeahead.css" rel="stylesheet" />
	<link type="text/css" rel="stylesheet" href="css/my.css" />
	<!-- Load polyfills to support older browsers -->
	<script src="js/polyfill.min.js"></script>
	<!-- Required scripts -->
	<script src="js/vue.js"></script>
	<script src="js/bootstrap-vue.js"></script>
	<script src="js/bootstrap-vue-icons.min.js"></script>
	<!-- Type Ahead Library -->
	<script src="js/VueBootstrapTypeahead.umd.min.js"></script>
	<!-- Graphical Suppor -->
	<script src="raphael.js"></script>
	<!-- Device Library -->
	<script src="deviceList.js"></script>



</head>

<body>
	<div id="app">

		<b-navbar toggleable="lg" type="dark" variant="info">
			<b-navbar-brand href="#">NeuroTool</b-navbar-brand>

			<b-navbar-toggle target="nav-collapse"></b-navbar-toggle>

			<b-collapse id="nav-collapse" is-nav>
				<b-navbar-nav>
				</b-navbar-nav>

				<b-navbar-nav class="ml-auto">
					<b-nav-item-dropdown right>

						<template #button-content>
							Help
						</template>
						<b-dropdown-item v-b-modal.help_modal>About</b-dropdown-item>
					</b-nav-item-dropdown>
				</b-navbar-nav>
			</b-collapse>
		</b-navbar>

		<b-container>

<p></p><p></p>

<div id = "intro_text" v-show="deviceInputs.length ==1 && deviceInputs[0].active == null">
	<b-jumbotron  bg-variant="light" style="text-align: center" lead="Independent neurointerventional device information and  compatibility. ">
		<b-button variant="primary" v-b-modal.help_modal>Help</b-button>
	</b-jumbotron>
  </div>


			<template v-for="n in deviceInputs"  >
				
				<b-form-group  :label-cols="n.hierarchy"  :key="n.id"       :label="n.hierarchy_text" label-size="sm" > 		
	
							<vue-bootstrap-typeahead  :key="n.id" :data="devices" :placeholder="n.text" :serializer="item => item.name_man"
							@hit="updateDevice(n.id, $event); updateSizer()" >
							</vue-bootstrap-typeahead>

							<div class="text-right" style="color:rgb(124, 124, 124); font-size: 0.9em; ">{{n.display_info}}  </div>


							<div class="text-right">
							<b-button-group  >
								<b-dropdown variant="success" style="font-size: 0.9em;" right >
									<template #button-content >
										<b-icon icon="plus" ></b-icon>
										Fit
									  </template>

								<b-dropdown-item variant="outline-secondary" class="btn btn-sm  py-0"  @click="addInput('inside', 'Enter device e.g. catheter, balloon, stent, wire ...', 'guide catheters', n.id); 
									">Fit device inside</b-dropdown-item>
									
								<b-dropdown-item v-show= "n.hierarchy != 0" class="btn btn-sm  py-0"  variant="outline-secondary" class="btn btn-sm  py-0"  @click="addInput('beside', 'Enter device e.g. catheter, balloon, stent, wire ...', 'guide catheters', n.id)">Fit device beside</b-dropdown-item>

								<b-dropdown-item v-show= "n.active != null" class="btn btn-sm  py-0"  variant="outline-secondary" class="btn btn-sm  py-0"  @click="fitLaunch(n.id)">What devices does this fit inside?</b-dropdown-item>

								</b-dropdown>

								<b-button  v-show= "n.hierarchy != 0" variant="danger" class="btn btn-sm  py-0" style="font-size: 0.9em;" @click="removeInput(n.id)">
									<b-icon icon="x-circle" scale="0.8" ></b-icon>
									Remove</b-button>

								<b-dropdown v-show= "n.hierarchy == 0 && n.active != null" variant="secondary" style="font-size: 0.9em;" right >
									<template #button-content >
										<b-icon icon="arrow-up-circle" scale="0.8" ></b-icon>
										{{access}}
									  </template>

									  <b-dropdown-item  class="btn btn-sm  py-0"  variant="outline-secondary" class="btn btn-sm  py-0"  @click="access = 'Femoral artery'">Femoral artery</b-dropdown-item>

									  <b-dropdown-item  class="btn btn-sm  py-0"  variant="outline-secondary" class="btn btn-sm  py-0"  @click="access = 'Radial artery'">Radial artery</b-dropdown-item>

									  <b-dropdown-item  class="btn btn-sm  py-0"  variant="outline-secondary" class="btn btn-sm  py-0"  @click="access = 'Brachial artery'">Brachial artery</b-dropdown-item>

								</b-dropdown>

								<b-dropdown v-show= "n.active != null" variant="info" style="font-size: 0.9em;" right >
										<template #button-content >
											<b-icon icon="info-circle" scale="0.8" ></b-icon>
											Info
										  </template>
	
										  <b-dropdown-item  class="btn btn-sm  py-0"  variant="outline-secondary" class="btn btn-sm  py-0"  @click="info(n.id)">Device info</b-dropdown-item>

										  <b-dropdown-item  class="btn btn-sm  py-0"  variant="outline-secondary" class="btn btn-sm  py-0"  @click="compareLaunch(n.id)">Compare with ...</b-dropdown-item>
	
								</b-dropdown>

							</b-button-group>
							</div>
				</b-form-group>
			</template>

			<div id="inputs"></div>
		</b-container>

		<b-container  v-show="deviceInputs.length == 1 && deviceInputs[0].active != null">
			<b-jumbotron  bg-variant="warning"  lead="Tip ">
				<p>Add another device inside this one by seleting Add → New device inside</p>
			</b-jumbotron>
		</b-container>


		<b-container  id="result_container" v-show="deviceInputs.length >1 && deviceInputs[0].active != null ">

				<b-jumbotron  bg-variant="light"  >
				<p id="result" class="lead"></p>

				<div id="details" style="color:rgb(179, 179, 179)" ></div>
				<b-button size="sm" variant="danger" @click="" v-b-modal.feedback_modal>
						Disagree with this?
				</b-button>
				<b-button size="sm" href="http://neurotool.org/">
						Reset
				</b-button>
				<p></p>
		
				<div id="more" ></div>
				<div id="paper"></div>
				<p></p>
				</b-jumbotron>

		</b-container>

		<!---------------- MODALS -------------->

		<b-modal id="help_modal" title="NeuroTool: Help" ok-only>
			<p>A tool to help select the right devices for neurointerventional procedures.</p>
			<h4>How to use</h4>
			<p>Start to type the device you are interested in the search box and then select from the list that pops up. You can select catheters, wires, stents, balloons, and other devices. </p>
			<img src="img/help1.png" class="center"  width="75%" > 
			<p>Insert a device inside this one by selecting "Add" Then "New device inside". You can also view device information by selecting "Info". </p>
			<img src="img/help2.png"  class="center" width="75%" > 
			<p>Further devices can be inserted either inside or beside this device using "New device inside" or "New device beside". Under Results you will see whether the devices are compatible in terms of diameter and length. If there are incompatibilities then a message will appear describing the problem.  </p>
			<img src="img/help3.png" class="center"  width="75%" > 
			</b-modal>

	
		<b-modal :id="fitModal.id" :title="fitModal.title" ok-only >
			<p>The <b>{{fitModal.first_device.name}}</b> will fit inside ({{fitModal.n}} items): </p>
			<p></p><p></p>
			<div>
				<b-table sticky-header small :items="fitModal.table" :fields="fitModal.fields" style="font-size: 0.9em; " head-variant="light" :sort-by.sync="fitModal.sortBy" :sort-desc.sync="fitModal.sortDesc"
				></b-table>
			</div>
		</b-modal>

		<b-modal id="feedback_modal" title="Feedback" ok-only>
			<div id ="feedback">
				<form id="fs-frm" name="simple-contact-form" accept-charset="utf-8" action="https://formspree.io/f/xbjqrwnz" method="post">
					<fieldset id="fs-frm-inputs">
					  <textarea rows="5" name="message" id="message" placeholder="Enter text here." required=""></textarea>
					  <input type="hidden" name="_subject" id="email-subject" value="Contact Form Submission">
					</fieldset>
					<input type="submit" value="Submit">
				  </form>
				</div>
			</b-modal>

			<b-modal :id="infoModal.id" :title="infoModal.device.name" ok-only >
				The <b>{{infoModal.device.name}}</b> is a {{infoModal.device.type}} manufactured by {{infoModal.device.manufacturer}}. 
				<p></p>
				<div>
					<b-table small :items="info_table" style="font-size: 0.9em; " head-variant="light"></b-table>
				</div>
				<p v-show= "infoModal.device.url1 != null"> <b>Manufacturer information:  </b> 
					<b-link :href= "infoModal.device.url1"> Link</b-link> 
				</p>
				<p v-show= "infoModal.device.url2 != null"> <b>More information:  </b> 
					<b-link :href= "infoModal.device.url2"> Link</b-link> 
				</p>
				<p v-show= "infoModal.device.ifu != null"> <b>IFU:  </b> 
					<b-link :href= "infoModal.device.ifu"> Link</b-link> 
				</p>
			</b-modal>

			<b-modal :id="compareModal.id" :title="compareModal.title" ok-only >

				<p>Compare <b> {{ compareModal.first_device.name }} </b> with: </p>
				<vue-bootstrap-typeahead  :data="devices"  :serializer="item => item.name_man"
					@hit="compare_device($event)" >
				</vue-bootstrap-typeahead>

				<p></p><p></p>
					<div>
						<b-table small :items="compareModal.table" style="font-size: 0.9em; " head-variant="light"></b-table>
					</div>
			</b-modal>


	
		<b-container class="footer" >
			This tool is for educational purposes only. <b-link href="mailto: jeremy.lynch@gmail.com"> Contact us.</b-link>
		</b-container>
		  

	</div>


	<script>

		/* GENERIC FUNCTIONS */

		function strip_man(text) {
			const reg = /\s\(([^)]+)\)/;
			return (text.replace(reg, ""));
		}

		function in_to_mm(inches) {
			var mm = inches * 25.4;
			return mm;
		}

		function in_to_fr(inches) {
			var fr = inches * 76.2;
			return fr;
		}

		function in_to_all(inches) {
			var text = "";

			if (inches != null || inches == "0") {
				var in_short = inches.toFixed(4) + "\"";
				var mm = in_to_mm(inches).toFixed(2) + " mm";
				var fr = in_to_fr(inches).toFixed(1) + " Fr";
				text = 	in_short + " (" + mm + ", " + fr + ")";
			}
			else {
				text = "N/A"
			}
			return text;
		}

		function format_name(name) {
			return name.toLowerCase().replace(/\s+/g, '');
		}

		function parse_lengths(str) {
			var list = str;
			if (typeof str === 'string' || str instanceof String) {
				list = str.split(/\//);
				for (n = 0; n < list.length; n++) {
					list[n] = parseInt(list[n]);
				}
				list = list.sort();
			}
			else list = null; 

			if (Array.isArray(list)) {
				if (isNaN(list[0])) list[0] = null;  
			}
			return list;
		}

		function setupDevices(data) {
			data.forEach(device => {
				device.name = device.name.trim();
				device.name_man = device.name + " (" + device.manufacturer + ")";
			}
			)
		}

		function check_compatibility(parent, child) {
			var comment = "";

			parent_str = format_name(parent.name); 
			child_str = format_name(child.name);

			if (parent.incompatibility != null) {
				var parent_incompat = parent.incompatibility.split(/\//);
			}
			if (child.incompatibility != null) {
				var child_incompat = parent.incompatibility.split(/\//);
			}

			//DMSO

			if (child_str.search("onyx") != -1 || child_str.search("phil") != -1 || child_str.search("squid") != -1) {
				if (parent.dmso != null) {
					if (parent.dmso != "yes") {
						comment += parent.name + " is not DMSO compatible. "; 
					}
				}
				else {
					comment += parent.name + " is not DMSO compatible. "; 
				}
			}

			return comment; 
		}

		function compare_list_lengths(parent_str, child_str, parent_name, child_name) { 

			parent_list = parse_lengths(parent_str);
			child_list = parse_lengths(child_str); 
			var solution_list = [];
			var solution_text = "";
			var problem_list = [];

			/* No lengths for 1 catheter or if catheters are the same type */
			if (parent_list != null && parent_list[0] != null && child_list != null && child_list[0] != null && parent_name != child_name)
			{
				/* Only one length for each catheter and they both fit */ 
				if (parent_list.length == 1 && child_list.length == 1 && parent_list[0] < child_list[0]) solution_text = ""; 
				else {

					for (var x = 0; x < child_list.length; x++) {
						for (var y = 0; y < parent_list.length; y++) {
							if (child_list[x] > parent_list[y]) {	/* Obtain all combinations that will fit */					
								solution_list.push(
									" " + parent_name + " " + parent_list[y] + " cm and " + child_name + " " + child_list[x] + " cm"
								);
							}
							if (child_list[x] <= parent_list[y]) {	/* Obtain all combinations that will NOT fit */				
								problem_list.push(
									" " + parent_name + " " + parent_list[y] + " cm and " + child_name + " " + child_list[x] + " cm"
								);
							}


						}
					}
					solution_list = solution_list.sort();
					problem_list = problem_list.sort(); 

					/* Write the text */

					switch (solution_list.length) {
						case 1: /* Just 1 solution */
							solution_text = "The following combinations of lengths is necessary: " + solution_list[0] + ". ";
							break;
						case (child_list.length * parent_list.length): /* All combinations are fine */
							solution_text = "";
							break;
						case 0: /* There are no solutions */ 
							solution_text = child_name + " is too short for the " + parent_name + ". "; 
							break
						default: /* There are a few solutions */
							if (solution_list.length < problem_list.length) {
								solution_text = "Avoid the following combinations of lengths: " + solution_list.toString() + ". ";
							}
							else {
								solution_text = "Avoid the following combinations of lengths: " + problem_list.toString() + ". ";
							}
							break
					}
				}
			}

			return solution_text;
		}

		/* GLOBAL VARIABLES */

		var tXML = "<root id=\"root\"></root>";
		var tree = (new DOMParser).parseFromString(tXML, "text/xml"); // Stores device info
		var deviceInputs = []; // Stores info about input boxes

		setupDevices(deviceList);

		/* Specific functions */

		function checkSizes() {
			var summary = "";
			var x = tree.querySelectorAll("device");
			x.forEach(parent => {
				if (parent.hasChildNodes() && (parent.getAttribute("data") != "")) {
					
					var parent_data = JSON.parse(parent.getAttribute("data"));

					children = parent.childNodes;
					var child_total_od = 0;
					var child_list = [];
					var length_txt = "";
					var child_str = "";
					var compat_str = "";

					children.forEach(child => { /* Add up all devices inside parent catheter */
							if (child.getAttribute("data") != "") {
							child_data = JSON.parse(child.getAttribute("data"));

							if (child_data.recommendedParentId != null) {
								child_total_od = child_total_od + child_data.recommendedParentId ;
							}
							else {
								child_total_od = child_total_od + child_data.maxod;
							}
							child_list.push(child_data.name);

							// Compare lengths
							length_txt = length_txt + compare_list_lengths(parent_data.length, child_data.length, parent_data.name, child_data.name);

							// Compare compatibility
							compat_str = compat_str + check_compatibility(parent_data, child_data);

						}
						}
					)
					
					if (child_total_od >= parent_data.minid) {
						switch (child_list.length) {
						case 1: 
							child_str = child_list[0];
							break;
						case 2:
							child_str = "The combination of " + child_str + child_list[0] + " and " + child_list[1]; 
							break;
						default:
						child_str = child_str + "The combination of ";
							for (var n=0; n < child_list.length; n++) {	
								if (n < (child_list.length-1)) child_str = child_str + child_list[n] + ", "; 
								if (n == (child_list.length-1)) child_str = child_str + " and " + child_list[n] + ",";
							}
							break;
						}
						summary = "<p style=\"color:red\">" + summary + child_str + " does not fit in to " + parent_data.name + ". " +  "</p>";
					}
					else summary = summary + length_txt + compat_str;
				}
			}
			)

			summary = summary; 

			return summary;
		}


		var address = "https://evtoday.com/device-guide/us";


		window.app = new Vue({
			components: {
				VueBootstrapTypeahead
			},
			el: '#app',
			data: {
				access: 'Femoral artery',
				devices: deviceList,
				deviceInputs: deviceInputs,
				id_count: 0,
				infoModal: {
					id: 'info-modal',
					device: {
						name:null,
						type:null,
						manufacturer: null,
						url1: null,
						url2: null,
						ifu:null
						},
					},
				fitModal: {
					id: 'fit-modal',
					title: 'Fit Inside',
					first_device: "",
					n:0,
					table : [],
					fields: [
						{
							key: 'Name',
							sortable: false
						},
						{
							key: 'minid',
							label: "Minimum inner diameter (inches)",
							sortable: true
						},
						{
							key: 'maxod',
							label: "Maximum outer diameter (inches)",
							sortable: true
						},
						{
							key: 'Lengths',
							sortable: false
						},
						],
					sortBy: 'minid',
        			sortDesc: false,
					},
				compareModal: {
				id: 'compare-modal',
				title: 'Compare',
				first_device: "",
				second_device: "",
				table : []
				},

				info_table:  [
						]
			},

			methods: {
				updateDevice: function (passed, e) {
					tree.getElementById(passed).setAttribute("data", JSON.stringify(e));

					var index = deviceInputs.findIndex(
								function (i) {
									return i.id == passed;
								}
							);
					

					deviceInputs[index].display_info = 	"OD: " + e.maxod.toFixed(4) + "."; 

					if (e.minid != null && e.minid != 0) deviceInputs[index].display_info += " ID: " +  e.minid.toFixed(4) + ".";
					if (e.length != null) deviceInputs[index].display_info += " " + e.length + " cm"; 
					deviceInputs[index].active = "true";

				},
				drawDiagram: function () {
					//var paper = Raphael("paper", 500, 500);
					//var rect1 = paper.rect(20, 30, 100, 12).attr({ fill: "orange" });

						/*
			Draw a  circle much larger than the combine diameters of the smaller circles
			Put the smaller circles in it
			Iterate:
			* Reduce the size of the circle
			* Check whether the new circle intersects the inside circles
			** If not then continue to decrease the size of the circle
			*** If so then find all the circles it intersects and move them towards the centre of the circles. Then check whether any of the inside circles intersects. 

			*/
				},

				info: function(index) {
					var deviceInfo = JSON.parse(tree.getElementById(index).getAttribute("data")); 
					this.infoModal.device = deviceInfo;
					this.info_table = [];

					this.info_table.push(
						{
						'Maximum outer diameter': in_to_all(deviceInfo.maxod),
						'Minimum inner diameter': in_to_all(deviceInfo.minid), 
						Lengths: deviceInfo.length + " cm"
						}
					);
					var content = "";
					if (deviceInfo.url1 != null) content += "<p><b>Links: </b><a target=\"_blank\". href=\"" + deviceInfo.url1 + "\">Manufacturer information</a></p>";
					if (deviceInfo.url2 != null) content += "<p><b>More info: </b><a target=\"_blank\". href=\"" + deviceInfo.url2 + "\">Information</a></p>";


					//document.getElementById("info_content").innerHTML = content;
					this.$root.$emit('bv::show::modal', this.infoModal.id);
				},
				resetInfoModal() {
					this.infoModal.title = ''
				},

				compareLaunch: function(index) {
					this.compareModal.first_device = JSON.parse(tree.getElementById(index).getAttribute("data")); 
					var second_device = index; 
					this.compareModal.table = [];	
					this.$root.$emit('bv::show::modal', this.compareModal.id);
				},

				compare_device: function(index) {
					var second_device = index; 
					this.compareModal.table = [];
					
					this.compareModal.table.push(
						{
						Name: this.compareModal.first_device.name + " (" + this.compareModal.first_device.manufacturer+ ")", 
						'Maximum outer diameter': in_to_all(this.compareModal.first_device.maxod),
						'Minimum inner diameter': in_to_all(this.compareModal.first_device.minid), 
						Lengths: this.compareModal.first_device.length + " cm"
						},
						{
						Name: second_device.name + " (" + second_device.manufacturer+ ")",
						'Maximum outer diameter': in_to_all(second_device.maxod),
						'Minimum inner diameter': in_to_all(second_device.minid), 
						Lengths: second_device.length + " cm"
						}
					);
				},

				fitLaunch: function(index) {
					this.fitModal.first_device = JSON.parse(tree.getElementById(index).getAttribute("data")); 
					var first_device = this.fitModal.first_device;
					this.fitModal.n=0;

					deviceList.forEach(d => {
						var required_id = null;
						if (first_device.recommendedParentId != null) required_id = first_device.recommendedParentId;
						else required_id = first_device.maxod;
						if (required_id < d.minid) {
							this.fitModal.table.push(		
								{ 
									Name: d.name + " (" + d.manufacturer+ ")",
									minid: d.minid, 
									maxod: d.maxod,
									Lengths: d.length + " cm"
								}
								);
							this.fitModal.n++;
						}
					});

					//console.log(this.fitModal.table);

					this.fitModal.table.sort(function(a, b){
						return b[2]-a[2]
					}
						);
					

					this.$root.$emit('bv::show::modal', this.fitModal.id);
				},

				updateSizer: function () {

					var result = checkSizes();
					if (result == "") {
						var result = "<p style=\"color:green\">Everything fits ok.</p>";
					}

					document.getElementById("result").innerHTML = result;
					//this.drawDeviceTable();
					this.drawDiagram();
				},
				addInput: function (where, text, type, parent) {

					id = "device" + this.id_count;
					this.id_count++;

					// Set up GUI
					var node = {};
					node.child_id = id;

					var n = { 'id': id, 'text': text, 'type': type, 'parent': parent, 'hierarchy': 0, 'hierarchy_text': '' , 'display_info': "", active: null };

					// Set up data structure
					var struct = tree.createElement("device");
					struct.setAttribute("id", id);
					struct.setAttribute("type", type);
					struct.setAttribute("data", "");

					// Get where in parent hierarchy
					var a = tree.getElementById(parent);
					var els = [];
					while (a) { 	
						els.unshift(a);
						a = a.parentNode;
					}
					
					// First element
					if (parent == null) {
						deviceInputs.splice(0, 0, n);
						tree.getElementById("root").appendChild(struct);
					}
					else {

						if (where == "inside") { 	// Add below target device
							n.hierarchy = els.length - 2;

							var index = deviceInputs.findIndex(
								function (i) {
									return i.id == parent;
								}
							);
							deviceInputs.splice(index + 1, 0, n);

							tree.getElementById(parent).appendChild(struct);

						}
						else {						// Add beside target device
							if (parent != "device0") {
								n.hierarchy = els.length - 3;
								n.parent = tree.getElementById(parent).parentNode.id;

								var index = deviceInputs.findIndex(
									function (i) {
										return i.id == parent;
									}
								);
								deviceInputs.splice(index, 0, n);

								tree.getElementById(parent).parentNode.appendChild(struct);
								
							}
							
						}
					}

					for (var i = 0; i < n.hierarchy; i++) {
						n.hierarchy_text = n.hierarchy_text + '◼   ';
					}


					return id;
				},
				removeInput: function (id) {
				
				if (id != "device0") {
					tree.getElementById(id).remove(); 
					var index = deviceInputs.findIndex(
									function (i) {
										return i.id == id;
									}
								);
					deviceInputs.splice(index, 1);
					this.updateSizer();
								}

			}
			},

	

			created: function () {
				var newInput1 = this.addInput("inside", "Enter outer device e.g. guide sheath ", "guide catheters", null);
			}
		})



	</script>


</body>

</html>