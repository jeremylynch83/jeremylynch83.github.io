<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<title>NeuroTool: Neurointervention Device Sizer</title>
	<link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
	<link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css" />
	<link href="https://unpkg.com/vue-bootstrap-typeahead/dist/VueBootstrapTypeahead.css" rel="stylesheet" />
	<link type="text/css" rel="stylesheet" href="my.css" />
	<!-- Load polyfills to support older browsers -->
	<script src="https://polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver"></script>
	<!-- Required scripts -->
	<script src="https://unpkg.com/vue@latest/dist/vue.js"></script>
	<script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
	<!-- Type Ahead Library -->
	<script src="https://unpkg.com/vue-bootstrap-typeahead"></script>
	<!-- Device Library -->
	<script src="deviceList.js"></script>
	<script src="raphael.js"></script>


</head>

<body>
	<div id="app">

		<b-navbar toggleable="lg" type="dark" variant="info">
			<b-navbar-brand href="#">NeuroTool (Beta)</b-navbar-brand>

			<b-navbar-toggle target="nav-collapse"></b-navbar-toggle>

			<b-collapse id="nav-collapse" is-nav>
				<b-navbar-nav>
				</b-navbar-nav>

				<b-navbar-nav class="ml-auto">
					<b-nav-item right href="#">Settings</b-nav-item>

					<b-nav-item-dropdown right>

						<template #button-content>
							Help
						</template>
						<b-dropdown-item v-b-modal.about_modal>About</b-dropdown-item>
					</b-nav-item-dropdown>
				</b-navbar-nav>
			</b-collapse>
		</b-navbar>

		<b-modal id="about_modal" title="DeviceSizer" ok-only>
			<p>A tool to help select the right catheters for neurointerventional procedures.</p>
			<p>Written by Dr Jeremy Lynch. With thanks to: Dr Patrick Nicholson. </p>
		</b-modal>


		<b-modal id="new_input" title="DeviceSizer" ok-only>
			<p>Test. </p>
			<template #modal-footer="{ ok, cancel, hide }">
				<b>Custom Footer</b>
				<!-- Emulate built in modal footer ok and cancel button actions -->
				<b-button size="sm" variant="success" @click="ok()">
					OK
				</b-button>
				<b-button size="sm" variant="danger" @click="cancel()">
					Cancel
				</b-button>
				<!-- Button with custom close trigger value -->
				<b-button size="sm" variant="outline-secondary" @click="hide('forget')">
					Forget it
				</b-button>
			</template>
		</b-modal>

		<b-container>

<h3></h3>			
			<h3>Select devices</h3>
			<template v-for="n in deviceInputs"  >
				<b-form-group  :label-cols="n.hierarchy"  :key="n.id">
	
							<vue-bootstrap-typeahead  :key="n.id" :data="devices" :placeholder="n.text" :serializer="item => item.name"
							@hit="updateDevice(n.id, $event); updateSizer()">
							</vue-bootstrap-typeahead>

							<div class="text-right">
							<b-button-group  >
								<b-button variant="outline-secondary" class="btn btn-sm  py-0" style="font-size: 0.7em;" @click="addInput('inside', 'Enter device e.g. catheter, balloon, stent, wire ...', 'guide catheters', n.id)">Add another inside</b-button>
								<b-button  variant="outline-secondary" class="btn btn-sm  py-0" style="font-size: 0.7em;" @click="addInput('beside', 'Enter device e.g. catheter, balloon, stent, wire ...', 'guide catheters', n.id)">Add another beside</b-button>
								<b-button  variant="outline-secondary" class="btn btn-sm  py-0" style="font-size: 0.7em;" @click="removeInput(n.id)">Remove</b-button>
							</b-button-group>
						</div>


				</b-form-group>
			</template>

			<div id="inputs"></div>
		</b-container>

		<b-container style="display: none" id="result_container">

			<h3>Results</h3>
			<strong>
				<p id="result" style="color:rgb(179, 179, 179)">You need to enter some devices ;)</p>
			</strong>
			<div id="details" style="color:rgb(179, 179, 179)" ></div>
			<div id="more" ></div>
			<div id="paper"></div>

			<p></p>
			<p>Note: This tool is in development and there may occasionally be inaccuracies in results. <b-link href="mailto: jeremy.lynch@gmail.com">Devices missing or incorrect? Contact me.</b-link>
			</p>

			
		</b-container>

	</div>


	<script>

		/* GENERIC FUNCTIONS */

		function strip_man(text) {
			const reg = /\s\(([^)]+)\)/;
			return (text.replace(reg, ""));
		}

		function in_to_mm(inches) {
			var mm = inches * 25.4;
			return mm;
		}

		function in_to_fr(inches) {
			var fr = inches * 76.2;
			return fr;
		}

		function parse_lengths(str) {
			var list = str;
			if (typeof str === 'string' || str instanceof String) {
				list = str.split(/\//);
				for (n = 0; n < list.length; n++) {
					list[n] = parseInt(list[n]);
				}
				list = list.sort();
			}
			else list = null; 

			if (Array.isArray(list)) {
				if (isNaN(list[0])) list[0] = null;  
			}

			return list;
		
		}

		function compare_list_lengths(parent_str, child_str, parent_name, child_name) { 

			parent_list = parse_lengths(parent_str);
			child_list = parse_lengths(child_str); 
			var solution_list = [];
			var solution_text = "";
			var problem_list = [];

			/* No lengths for 1 catheter or if catheters are the same type */
			if (parent_list != null && parent_list[0] != null && child_list != null && child_list[0] != null && parent_name != child_name)
			{
				/* Only one length for each catheter and they both fit */ 
				if (parent_list.length == 1 && child_list.length == 1 && parent_list[0] < child_list[0]) solution_text = ""; 
				else {

					for (var x = 0; x < child_list.length; x++) {
						for (var y = 0; y < parent_list.length; y++) {
							if (child_list[x] > parent_list[y]) {	/* Obtain all combinations that will fit */					
								solution_list.push(
									" " + strip_man(parent_name) + " " + parent_list[y] + " cm and " + strip_man(child_name) + " " + child_list[x] + " cm"
								);
							}
							if (child_list[x] <= parent_list[y]) {	/* Obtain all combinations that will NOT fit */				
								problem_list.push(
									" " + strip_man(parent_name) + " " + parent_list[y] + " cm and " + strip_man(child_name) + " " + child_list[x] + " cm"
								);
							}


						}
					}
					solution_list = solution_list.sort();
					problem_list = problem_list.sort(); 

					/* Write the text */

					switch (solution_list.length) {
						case 1: /* Just 1 solution */
							solution_text = "Note, the following combinations of lengths is necessary" + solution_list[0] + ". ";
							break;
						case (child_list.length * parent_list.length): /* All combinations are fine */
							solution_text = "";
							break;
						case 0: /* There are no solutions */ 
							solution_text = strip_man(child_name) + " is too short for the " + strip_man(parent_name) + ". "; 
							break
						default: /* There are a few solutions */
							if (solution_list.length < problem_list.length) {
								solution_text = "Note, the following combinations of lengths will not fit: " + solution_list.toString() + ". ";
							}
							else {
								solution_text = "Note, the following combinations of lengths will NOT fit: " + problem_list.toString() + ". ";
							}
							break
					}
				}
			}

			return solution_text;
		}

		/* GLOBAL VARIABLES */

		var tXML = "<root id=\"root\"></root>";
		var tree = (new DOMParser).parseFromString(tXML, "text/xml"); // Stores device info
		var deviceInputs = []; // Stores info about input boxes

		/* Specific functions */

		function checkSizes() {
			var summary = "";
			var x = tree.querySelectorAll("device");
			x.forEach(parent => {
				if (parent.hasChildNodes() && (parent.getAttribute("data") != "")) {
					
					var parent_data = JSON.parse(parent.getAttribute("data"));
					//summary = summary + "Parent: " + parent_data.name + ". ";

					children = parent.childNodes;
					var child_total_od = 0;
					var child_list = [];
					var length_txt = "";
					var child_str = "";

					children.forEach(child => { /* Add up all devices inside parent catheter */
							if (child.getAttribute("data") != "") {
							child_data = JSON.parse(child.getAttribute("data"));

							child_total_od = child_total_od + child_data.maxod;
							child_list.push(strip_man(child_data.name));

							// Compare lengths
							length_txt = length_txt + compare_list_lengths(parent_data.length, child_data.length, parent_data.name, child_data.name);

						}
						}
					)
					
					if (child_total_od > parent_data.minid) {
						switch (child_list.length) {
						case 1: 
							child_str = child_list[0];
							break;
						case 2:
							child_str = "The combination of " + child_str + child_list[0] + " and " + child_list[1]; 
							break;
						default:
						child_str = child_str + "The combination of ";
							for (var n=0; n < child_list.length; n++) {	
								if (n < (child_list.length-1)) child_str = child_str + child_list[n] + ", "; 
								if (n == (child_list.length-1)) child_str = child_str + " and " + child_list[n] + ",";
							}
							break;
						}
						summary = summary + child_str + " does not fit in to " + strip_man(parent_data.name) + ". ";
					}
					else summary = summary + length_txt;

					
				}
			}
			)
			return summary;
		}


		var address = "https://evtoday.com/device-guide/us";

		function generateDeviceTable() {
			var table = "<p></p><table id= \"detailsTable\">"
			table = table + "<tr><th>Name</th><th>Max outer</th><th>Min inner</th><th>Lengths</th></tr>";

			var x = tree.querySelectorAll("device");

			x.forEach(y => {
				var y_data = y.getAttribute("data");
				if (y_data != "") {
					var y_data_parsed = JSON.parse(y.getAttribute("data"));
					var maxod = y_data_parsed.maxod;
					var maxod_in = maxod.toFixed(4) + "\"";
					var maxod_mm = in_to_mm(maxod).toFixed(2) + " mm";
					var maxod_fr = in_to_fr(maxod).toFixed(1) + " fr";
					var minid = y_data_parsed.minid;
					var minid_in = minid.toFixed(4) + "\"";
					var minid_mm = in_to_mm(minid).toFixed(2) + " mm";
					var minid_fr = in_to_fr(minid).toFixed(1) + " fr";

					if (y_data_parsed.name != null) table = table + "<td>" + y_data_parsed.name + "</td>";
					if (y_data_parsed.maxod != null) table = table + "<td>" + maxod_in + " (" + maxod_mm + ", " + maxod_fr + ")" + "</td>";
					if (y_data_parsed.minid != null) table = table + "<td>" + minid_in + " (" + minid_mm + ", " + minid_fr + ")" + "</td>";
					if (y_data_parsed.length != null) table = table + "<td>" + y_data_parsed.length + " cm" + "</td>";
					table = table + "</tr>";
				}
			}
			)
			table = table + "</tr></tbody></table>";
			return table;
		}


		window.app = new Vue({
			components: {
				VueBootstrapTypeahead
			},
			el: '#app',
			data: {
				app_box: '',
				devices: deviceList,
				query: '',
				deviceInputs: deviceInputs,
				id_count: 0
			},

			methods: {
				updateDevice: function (passed, e) {
					tree.getElementById(passed).setAttribute("data", JSON.stringify(e));
				},
				drawDiagram: function () {
					//var paper = Raphael("paper", 500, 500);
					//var rect1 = paper.rect(20, 30, 100, 12).attr({ fill: "orange" });

						/*
			Draw a  circle much larger than the combine diameters of the smaller circles
			Put the smaller circles in it
			Iterate:
			* Reduce the size of the circle
			* Check whether the new circle intersects the inside circles
			** If not then continue to decrease the size of the circle
			*** If so then find all the circles it intersects and move them towards the centre of the circles. Then check whether any of the inside circles intersects. 

			*/
				},

				updateSizer: function () {
					var result = checkSizes();
					if (result == "") {
						document.getElementById("result").style.color = "rgb(0, 153, 51)";
						var result = "Everything fits ok.";
					}
					else {
						document.getElementById("result").style.color = "rgb(175,0,42)"
					}
					document.getElementById("result").innerHTML = result;
					document.getElementById("more").innerHTML = generateDeviceTable();

					this.drawDiagram();

					document.getElementById("result_container").style = "display:block";

				},
				addInput: function (where, text, type, parent) {

					id = "device" + this.id_count;
					this.id_count++;

					// Set up GUI
					var node = {};
					node.child_id = id;

					var n = { 'id': id, 'text': text, 'type': type, 'parent': parent, 'hierarchy': 0 };

					// Set up data structure
					var struct = tree.createElement("device");
					struct.setAttribute("id", id);
					struct.setAttribute("type", type);
					struct.setAttribute("data", "");

					// Get where in parent hierarchy
					var a = tree.getElementById(parent);
					var els = [];
					while (a) { 	
						els.unshift(a);
						a = a.parentNode;
					}

					
					// First element
					if (parent == null) {
						deviceInputs.splice(0, 0, n);
						tree.getElementById("root").appendChild(struct);
					}
					else {

						if (where == "inside") { 	// Add below target device
							n.hierarchy = els.length - 2;

							var index = deviceInputs.findIndex(
								function (i) {
									return i.id == parent;
								}
							);
							deviceInputs.splice(index + 1, 0, n);

							tree.getElementById(parent).appendChild(struct);

						}
						else {						// Add beside target device
							if (parent != "device0") {
								n.hierarchy = els.length - 3;
								n.parent = tree.getElementById(parent).parentNode.id;

								var index = deviceInputs.findIndex(
									function (i) {
										return i.id == parent;
									}
								);
								deviceInputs.splice(index, 0, n);

								tree.getElementById(parent).parentNode.appendChild(struct);
								
							}
							
						}
					}

					return id;
				},
				removeInput: function (id) {
				
				if (id != "device0") {
					tree.getElementById(id).remove(); 
					var index = deviceInputs.findIndex(
									function (i) {
										return i.id == id;
									}
								);
					deviceInputs.splice(index, 1);
					this.updateSizer();
								}

			}
			},

			created: function () {
				var newInput1 = this.addInput("inside", "Enter outer device e.g. guide sheath ", "guide catheters", null);
			}
		})


		var parent = "100 ";
		var child = "115 "; 
		//console.log(compare_list_lengths(parent, child, "neuron max", "sl-10")); 



	</script>


</body>

</html>