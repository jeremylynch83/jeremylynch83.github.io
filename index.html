<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<title>Neurosizer: Neurointervention Device Sizer</title>
	<link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
	<link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css" />
	<link href="https://unpkg.com/vue-bootstrap-typeahead/dist/VueBootstrapTypeahead.css" rel="stylesheet" />
	<link type="text/css" rel="stylesheet" href="my.css" />
	<!-- Load polyfills to support older browsers -->
	<script src="https://polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver"></script>
	<!-- Required scripts -->
	<script src="https://unpkg.com/vue@latest/dist/vue.js"></script>
	<script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
	<!-- Type Ahead Library -->
	<script src="https://unpkg.com/vue-bootstrap-typeahead"></script>
	<!-- Device Library -->
	<script src="deviceList.js"></script>
	<script src="raphael.js"></script>


</head>

<body>
	<div id="app">

		<b-navbar toggleable="lg" type="dark" variant="info">
			<b-navbar-brand href="#">NeuroSizer</b-navbar-brand>

			<b-navbar-toggle target="nav-collapse"></b-navbar-toggle>

			<b-collapse id="nav-collapse" is-nav>
				<b-navbar-nav>
				</b-navbar-nav>

				<b-navbar-nav class="ml-auto">
					<b-nav-item right href="#">Settings</b-nav-item>

					<b-nav-item-dropdown right>

						<template #button-content>
							Help
						</template>
						<b-dropdown-item v-b-modal.about_modal>About</b-dropdown-item>
					</b-nav-item-dropdown>
				</b-navbar-nav>
			</b-collapse>
		</b-navbar>

		<b-modal id="about_modal" title="DeviceSizer" ok-only>
			<p>A tool to help select the right catheters for neurointerventional procedures.</p>
			<p>Written by Dr Jeremy Lynch. With thanks to: Dr Patrick Nicholson. </p>
		</b-modal>

		<b-modal id="new_input" title="DeviceSizer" ok-only>
			<p>Test. </p>
			<template #modal-footer="{ ok, cancel, hide }">
				<b>Custom Footer</b>
				<!-- Emulate built in modal footer ok and cancel button actions -->
				<b-button size="sm" variant="success" @click="ok()">
					OK
				</b-button>
				<b-button size="sm" variant="danger" @click="cancel()">
					Cancel
				</b-button>
				<!-- Button with custom close trigger value -->
				<b-button size="sm" variant="outline-secondary" @click="hide('forget')">
					Forget it
				</b-button>
			</template>
		</b-modal>

		<b-container>

			<h3></h3>
			<h3>Select devices</h3>
			<template v-for="n in deviceInputs"  >
				<b-form-group  :label-cols="n.hierarchy"  :v-bind:key="n.id">
	
							<vue-bootstrap-typeahead  :data="devices" :placeholder="n.text" :serializer="item => item.name"
							@hit="updateDevice(n.id, $event); updateSizer()">
							</vue-bootstrap-typeahead>

							<div class="text-right">
							<b-button-group  >
								<b-button variant="outline-secondary" class="btn btn-sm  py-0" style="font-size: 0.8em;" @click="addInput('inside', 'Enter device', 'guide catheters', n.id)">Add inside</b-button>
								<b-button  variant="outline-secondary" class="btn btn-sm  py-0" style="font-size: 0.8em;" @click="addInput('beside', 'Enter device', 'guide catheters', n.id)">Add beside</b-button>
								<b-button  variant="outline-secondary" class="btn btn-sm  py-0" style="font-size: 0.8em;" @click="removeInput(n.id)">Remove</b-button>

							</b-button-group>
						</div>


				</b-form-group>
			</template>

			<div id="inputs"></div>
		</b-container>

		<b-container>

			<h3>Results</h3>
			<strong>
				<p id="result" style="color:rgb(179, 179, 179)">You need to enter some devices ;)</p>
			</strong>
			<div id="details" style="color:rgb(179, 179, 179)"></div>
			<div id="more"></div>
			<div id="paper"></div>

			<p></p>

			<b-link href="mailto: jeremy.lynch@gmail.com">Devices missing or incorrect? Contact me.</b-link>

		</b-container>


	</div>


	<script>

		var tXML = "<root id=\"root\"></root>";
		var tree = (new DOMParser).parseFromString(tXML, "text/xml"); // Stores temporary device info

		/*var firstElement = tree.createElement("device");
		firstElement.setAttribute("id", "first");
		firstElement.setAttribute("type", "");
		firstElement.setAttribute("data", "");
		tree.getElementById("root").appendChild(firstElement);*/

		var deviceInputs = [];


		function strip_manufacturer(text) {
			const reg = /\s\(([^)]+)\)/;
			return (text.replace(reg, ""));
		}


		function checkSizes() {
			var summary = "";
			var x = tree.querySelectorAll("device");
			x.forEach(y => {
				var y_data = y.getAttribute("data");
				if (y_data != "") {
					var parent = y.parentNode;
					//console.log(JSON.parse(y.getAttribute("data")))

					var y_data_parsed = JSON.parse(y.getAttribute("data"));
					var total_od = y_data_parsed.maxod;

					var sibling = y.nextSibling;

					if (sibling != null) {
						var sibling_data = sibling.getAttribute("data");
						do {
							if (sibling_data != "") {
								total_od = total_od + JSON.parse(sibling_data).maxod;
							}
							sibling = sibling.nextSibling;
						}
						while (sibling != null);
					}

					if (parent.getAttribute("id") != "root") {
						if (parent.getAttribute("data") == "") {
							parent = parent.parentNode;
						}

						if (parent.getAttribute("data") != null && parent.getAttribute("data") != "") {
							//console.log(parent.getAttribute("data"));
							parent_data_parsed = JSON.parse(parent.getAttribute("data"));
							if (total_od > parent_data_parsed.minid) {
								summary = summary + strip_manufacturer(y_data_parsed.name) + " does not fit in to " + strip_manufacturer(parent_data_parsed.name) + ". ";
							}
						}
					}
				}
			}
			)
			return summary;
		}


		var address = "https://evtoday.com/device-guide/us";

		function generateDeviceTable() {
			var table = "<p></p><table id= \"detailsTable\">"
			table = table + "<tr><th>Name</th><th>Max outer</th><th>Min inner</th><th>Lengths</th></tr>";

			var x = tree.querySelectorAll("device");
			x.forEach(y => {
				var y_data = y.getAttribute("data");
				if (y_data != "") {
					var y_data_parsed = JSON.parse(y.getAttribute("data"));
					if (y_data_parsed.name != null) table = table + "<td>" + y_data_parsed.name + "</td>";
					if (y_data_parsed.maxod != null) table = table + "<td>" + y_data_parsed.maxod.toFixed(3) + "</td>";
					if (y_data_parsed.minid != null) table = table + "<td>" + y_data_parsed.minid.toFixed(3) + "</td>";
					if (y_data_parsed.length != null) table = table + "<td>" + y_data_parsed.length + "</td>";
					table = table + "</tr>";
				}
			}
			)
			table = table + "</tr></tbody></table>";
			return table;
		}


		window.app = new Vue({
			components: {
				VueBootstrapTypeahead
			},
			el: '#app',
			data: {
				app_box: '',
				devices: deviceList,
				query: '',
				deviceInputs: deviceInputs,
				id_count: 0
			},

			methods: {
				updateDevice: function (passed, e) {
					tree.getElementById(passed).setAttribute("data", JSON.stringify(e));
				},
				drawDiagram: function () {
					//var paper = Raphael("paper", 500, 500);
					//var rect1 = paper.rect(20, 30, 100, 12).attr({ fill: "orange" });

						/*
			Draw a  circle much larger than the combine diameters of the smaller circles
			Put the smaller circles in it
			Iterate:
			* Reduce the size of the circle
			* Check whether the new circle intersects the inside circles
			** If not then continue to decrease the size of the circle
			*** If so then find all the circles it intersects and move them towards the centre of the circles. Then check whether any of the inside circles intersects. 

			*/
				},

				updateSizer: function () {
					var result = checkSizes();
					if (result == "") {
						document.getElementById("result").style.color = "rgb(0, 153, 51)";
						var result = "Everything fits ok.";
					}
					else {
						document.getElementById("result").style.color = "rgb(175,0,42)"
					}
					document.getElementById("result").innerHTML = result;
					document.getElementById("more").innerHTML = generateDeviceTable();

					this.drawDiagram();

				},
				addInput: function (where, text, type, parent) {

					id = "device" + this.id_count;
					this.id_count++;

					// Set up GUI
					var node = {};
					node.child_id = id;

					// New way
					var n = { 'id': id, 'text': text, 'type': type, 'parent': parent, 'hierarchy': 0 };

					// Set up data structure
					var struct = tree.createElement("device");
					struct.setAttribute("id", id);
					struct.setAttribute("type", type);
					struct.setAttribute("data", "");

					// Get where in parent hierarchy
					var a = tree.getElementById(parent);
					var els = [];
					while (a) { 	
						els.unshift(a);
						a = a.parentNode;
					}

					console.log(parent);

					
					// First element
					if (parent == null) {
						deviceInputs.splice(0, 0, n);
						tree.getElementById("root").appendChild(struct);
					}
					else {

						if (where == "inside") { 	// Add below target device
							n.hierarchy = els.length - 2;

							var index = deviceInputs.findIndex(
								function (i) {
									return i.id == parent;
								}
							);
							deviceInputs.splice(index + 1, 0, n);


							tree.getElementById(parent).appendChild(struct);

						}
						else {						// Add beside target device
							//if (parent != "device0") {
								n.hierarchy = els.length - 3;
								n.parent = tree.getElementById(parent).parentNode.id;

								var index = deviceInputs.findIndex(
									function (i) {
										return i.id == parent;
									}
								);
								deviceInputs.splice(index, 0, n);

								tree.getElementById(parent).parentNode.appendChild(struct);
							//}
							
						}
					}

					return id;
				},
				removeInput: function (id) {
				
				if (id != "device0") {
					tree.getElementById(id).remove(); 
					var index = deviceInputs.findIndex(
									function (i) {
										return i.id == id;
									}
								);
					deviceInputs.splice(index, 1);
					this.updateSizer();
								}

			}
			},

			created: function () {
				var newInput1 = this.addInput("inside", "Enter outer device e.g. guide sheath ", "guide catheters", null);
				//var newInput2 = this.addInput("inside", "Enter intermediate device ", "intermediate catheters", newInput1);
				//var newInput3 = this.addInput("inside", "Enter micro device ", "microcatheters", newInput2);
				//var newInput4 = this.addInput("inside", "Enter micro device ", "microcatheters", newInput2);
			}
		})





	</script>


</body>

</html>