<!-- TODO

	* More templates
	* Text substitutions to shorten text
	* Associated info display
	* Copy templates from radReport?

-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>NeuroTool: Predictions</title>
    <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue.css" />
    <link href="css/VueBootstrapTypeahead.css" rel="stylesheet" />
    <link type="text/css" rel="stylesheet" href="css/mytemplate.css" />
    <!-- Load polyfills to support older browsers -->
    <script src="js/polyfill.min.js"></script>
    <!-- Required scripts -->
    <script src="js/vue.js"></script>
    <script src="js/bootstrap-vue.js"></script>
    <script src="js/lodash.js"></script>
    <script src="js/papaparse.js"></script>
    <!-- Type Ahead Library -->
    <script src="js/VueBootstrapTypeahead.umd.min.js"></script>
</head>

<body>
    <div id="app">

        <b-navbar toggleable="lg" type="dark" variant="info">
            <b-navbar-brand href="#">NeuroTool</b-navbar-brand>

            <b-navbar-toggle target="nav-collapse"></b-navbar-toggle>

            <b-collapse id="nav-collapse" is-nav>
                <b-navbar-nav>
                </b-navbar-nav>

                <b-navbar-nav class="ml-auto">
                    <b-nav-item-dropdown right>

                        <template #button-content>
                            Help
                        </template>
                        <b-dropdown-item v-b-modal.help_modal>About</b-dropdown-item>
                    </b-nav-item-dropdown>
                </b-navbar-nav>
            </b-collapse>
        </b-navbar>


        <b-container fluid="sm">
            <p></p>
            <b-container style="background-color:rgb(255, 255, 239); padding: 10px; border-radius: 5px">
                <p>This website is under development. Please email me at <a
                        href="mailto: jeremy.lynch@gmail.com">jeremy.lynch@gmail.com</a> for any comments or
                    suggestions. </p>
            </b-container>
            <p></p>
            <template>
                <b-container fluid>

                    <b-row class="my-1" v-for="n in score.variables" :key="n.name">
                        <b-col sm="3">
                            <label>{{ n.text }}:</label>
                        </b-col>
                        <b-col sm="9">
                            <b-form-input v-if="n.type == 'text'|| n.type =='number'" :id="`n.name-${n.name}`"
                                :type="n.type" v-model="n.selected">
                            </b-form-input>

                            <b-form-select v-if="n.type == 'select'" :id="`n.name-${n.name}`" :options="n.options"
                                v-model="n.selected">
                            </b-form-select>

                            <b-form-radio-group v-if="n.type == 'radio'" :id="`n.name-${n.name}`" :options="n.options"
                                v-model="n.selected">
                            </b-form-radio-group>
                        </b-col>
                    </b-row>

                </b-container>
            </template>
            <p></p>
            <p></p>

            <b-button @click="calculate()">Calculate</b-button>
            <p></p>

            <b-container>
                <b-jumbotron bg-variant="light">
                    <div id="result_text" class="lead"></div>
                    <p></p>
                </b-jumbotron>

            </b-container>


            <!---------------- MODALS -------------->

            <b-modal id=" help_modal" title="NeuroTool: Help" ok-only>
            </b-modal>

            <b-container class="footer">
                This tool is for educational purposes only. <b-link href="mailto: jeremy.lynch@gmail.com"> Contact
                    us.
                </b-link>
            </b-container>

    </div>


    <script>
        /* GENERIC FUNCTIONS */


        function flatten(data) {
            var result = {};

            function recurse(cur, prop) {
                if (Object(cur) !== cur) {
                    result[prop] = cur;
                } else if (Array.isArray(cur)) {
                    for (var i = 0, l = cur.length; i < l; i++)
                        recurse(cur[i], prop + "[" + i + "]");
                    if (l == 0)
                        result[prop] = [];
                } else {
                    var isEmpty = true;
                    for (var p in cur) {
                        isEmpty = false;
                        recurse(cur[p], prop ? prop + "." + p : p);
                    }
                    if (isEmpty && prop)
                        result[prop] = {};
                }
            }
            recurse(data, "");
            return result;
        }

        function get_var(name, array) {

            var match = null;
            for (var n = 0; n < array.length; n++) {
                if (array[n].name == name) match = n;
            }

            return array[match];
        }


        /* PREDICTION TOOLS */

        aneurysm_risk = {}
        aneurysm_risk.variables = [{
                name: "size",
                score: "phases",
                type: "number",
                text: "Enter size in mm",
                selected: null,
                phases_score: function () {
                    var total = 0;
                    if (this.selected) {
                        if (this.selected < 7) total = 0;
                        if (this.selected >= 7 && this.selected < 10) total = 3;
                        if (this.selected >= 10 && this.selected < 20) total = 6;
                        if (this.selected >= 20) total = 10;

                    }
                    return total;
                },
                isuia_score: function () {
                    var total = 0;
                    if (this.selected) {
                        if (this.selected < 7) total = 0;
                        if (this.selected >= 7 && this.selected < 13) total = 1;
                        if (this.selected >= 13 && this.selected < 25) total = 2;
                        if (this.selected >= 25) total = 3;
                    }
                    return total;
                }
            },
            {
                name: "site",
                score: "phases",
                type: "select",
                options: [{
                        value: 'cavernous',
                        text: 'Cavernous ICA'
                    }, {
                        value: 'ica',
                        text: 'Intradural ICA'
                    },
                    {
                        value: 'mca',
                        text: 'MCA'
                    },
                    {
                        value: 'aca',
                        text: 'ACA'
                    },
                    {
                        value: 'acom',
                        text: 'ACom'
                    },
                    {
                        value: 'pca',
                        text: 'PCA/PCOM'
                    },
                    {
                        value: 'va',
                        text: 'Vertebral artery'
                    },
                    {
                        value: 'ba',
                        text: 'Basilar artery'
                    }
                ],
                text: "Enter site",
                selected: null,
                phases_score: function () {
                    var total = 0;
                    if (this.selected) {
                        if (this.selected == "cavernous") total = -1;
                        if (this.selected == "ica") total = 0;
                        if (this.selected == "mca") total = 2;
                        if (this.selected == "pca" || this.selected == "pcom" || this.selected == "va" || this
                            .selected == "ba" || this.selected == "aca" || this
                            .selected == "acom") total = 4;
                    }
                    return total;
                },
                isuia_score: function () {
                    var total = 0;
                    if (this.selected) {
                        if (this.selected == "cavernous") total = 0;
                        if (this.selected == "mca" || this.selected == "aca" || this
                            .selected == "acom" || this
                            .selected == "ica") total = 1;
                        if (this.selected == "pca" || this.selected == "pcom" || this.selected == "va" || this
                            .selected == "ba") total = 2;
                    }
                    return total;
                },

            },
            {
                name: "ethnicity",
                score: "phases",
                type: "select",
                options: [{
                        value: 'american',
                        text: 'North American/European (except Finnish)'
                    },
                    {
                        value: 'japanese',
                        text: 'Japanese'
                    },
                    {
                        value: 'finnish',
                        text: 'Finnish'
                    },
                    {
                        value: 'other',
                        text: 'Other'
                    }
                ],
                text: "Enter ethnicity",
                selected: null,
                phases_score: function () {
                    var total = 0;
                    if (this.selected) {
                        if (this.selected == "american" || this.selected == "other") total = 0;
                        if (this.selected == "japanese") total = 3;
                        if (this.selected == "finnish") total = 5;
                    }
                    return total;

                }
            },
            {
                name: "hypertension",
                score: "phases",
                options: [{
                    value: 1,
                    text: 'yes'
                }, {
                    value: 0,
                    text: 'no'
                }],
                type: "radio",
                text: "Does the patient have hypertension?",
                selected: null,
                phases_score: function () {
                    return this.selected;

                }
            },
            {
                name: "Age",
                score: "phases",
                type: "number",
                text: "Enter age in years",
                selected: null,
                phases_score: function () {
                    var total = 0;
                    if (this.selected && this.selected > 70) {
                        total = 1;
                    }
                    return total;

                }
            },
            {
                name: "other_sah",
                score: "phases",
                options: [{
                    value: 1,
                    text: 'yes'
                }, {
                    value: 0,
                    text: 'no'
                }],
                type: "radio",
                text: "Has the patient ever had subarachnoid haemorrhage from another aneurysm?",
                selected: null,
                phases_score: function () {
                    return this.selected;
                }
            }
        ]
        aneurysm_risk.calculate = function () {
            var text = "";

            // PHASES
            const phases_table = {
                0: "0.4\% (0.1-1.5\%)",
                1: "0.4\% (0.1-1.5\%)",
                2: "0.4\% (0.1-1.5\%)",
                3: "0.7\% (0.1-1.5\%)",
                4: "0.9\% (0.1-1.5\%)",
                5: "1.3\% (0.1-1.5\%)",
                6: "1.7\% (0.1-1.5\%)",
                7: "2.4\% (0.1-1.5\%)",
                8: "3.2\% (0.1-1.5\%)",
                9: "4.3\% (0.1-1.5\%)",
                10: "5.3\% (0.1-1.5\%)",
                11: "7.2\% (0.1-1.5\%)",
            }
            var total = 0;
            for (var n = 0; n < this.variables.length; n++) {
                total = total + this.variables[n].phases_score();
            }
            var risk = null;
            if (get_var("site", this.variables).isuia_score() != -1) {
                if (total >= 12) risk = "17·8\% (15·2–20·7\%)";
                else risk = phases_table[total];
                text = "<p>PHASES: " + risk + " 5-year risk. </p>";
            } else {
                text = "";
            }


            // ISUIA
            total = 0;
            risk = null;
            // Size 7mm
            if (get_var("other_sah", this.variables).selected && get_var("size", this.variables).isuia_score() ==
                0) {
                // Previously ruptured and < 7 mm
                if (get_var("site", this.variables).isuia_score() == 0) {
                    risk = "0\% "
                } else if (get_var("site", this.variables).isuia_score() == 1) {
                    risk = "1.5\% "
                } else if (get_var("site", this.variables).isuia_score() == 2) {
                    risk = "3.4\% "
                }
            } else if (get_var("size", this.variables).isuia_score() > 0) {
                // Not previously ruptured and < 7 mm
                if (get_var("site", this.variables).isuia_score() == 2) {
                    risk = "2.5\% "
                } else {
                    risk = "0\% ";
                }
            }
            const isuia_table = [
                [0, "0\%", "3\%", "6.4\%"],
                [0, "2.6\%", "14.6\%", "40\%"],
                [0, "18.4\%", "18.4\%", "50\%"]
            ];
            // [row][column]
            console.log("site: " + get_var("site", this.variables).isuia_score());
            console.log("size: " + get_var("size", this.variables)
                .isuia_score());
            var risk = isuia_table[get_var("site", this.variables).isuia_score()][get_var("size", this.variables)
                .isuia_score()
            ];

            text = text + "<p>ISUIA: " + risk + " 5-year risk.</p>";

            return text;

        }


        /* GLOBAL VARIABLES */

        window.app = new Vue({
            components: {
                VueBootstrapTypeahead
            },
            el: '#app',
            data: {
                id_count: 0,
                score: aneurysm_risk,

                copyModal: {
                    id: 'copy-modal',
                    text: "",
                    title: "Copy"
                }
            },

            methods: {
                // General functions
                calculate: function () {
                    document.getElementById("result_text").innerHTML = this.score.calculate();

                }


            }
        });
    </script>


</body>

</html>